@model PetCloud.Models.Appointment
@{
    Layout = "~/Views/Shared/_DashboardLayoutModern.cshtml";
    ViewBag.Title = "Add Multiple Appointments";
}

<div class="p-4">
    <h5 class="fw-bold mb-4">Appointments / Add Multiple</h5>
    <div class="card shadow-sm p-4">

        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
            <div id="messageToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <form id="addAppointmentForm" method="post" action="#">
            @Html.AntiForgeryToken()

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Owner</label>
                    <select id="ownerSelect" class="form-select select2">
                        <option value="">Select Owner</option>
                        @foreach (var owner in ViewBag.Owners)
                        {
                            <option value="@owner.OwnerID">@owner.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div id="appointmentsContainer"></div>

            <div class="mt-3 text-end">
                <button type="button" id="addMoreAppointments" class="btn btn-outline-primary">+ Add Service</button>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary px-4">Save</button>
                <a href="@Url.Action("Appointments", "Staff")" class="btn btn-secondary px-4">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title fw-bold">Add Service</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-0 fw-semibold">Add another service?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmAddBtn" class="btn btn-success px-4">Add</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmRemoveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title fw-bold">Remove Service</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-0 fw-semibold">Are you sure you want to remove this service?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmRemoveBtn" class="btn btn-danger px-4">Remove</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title fw-bold">Confirm Save</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-0 fw-semibold">Are you sure you want to save these appointments?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmSaveBtn" class="btn btn-success px-4">Confirm</button>
            </div>
        </div>
    </div>
</div>

<template id="appointmentTemplate">
    <div class="appointment-block border rounded p-3 mb-3 position-relative bg-light">
        <h6 class="fw-bold mb-3">Service #</h6>
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 mt-2 me-2 remove-appointment">×</button>

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-semibold">Pet</label>
                <select class="form-select pet-select select2" data-prop="PetID">
                    <option value="">Select Pet</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Service Category</label>
                <select class="form-select category-select select2" data-prop="CategoryID">
                    <option value="">Select Category</option>
                    @foreach (var cat in ViewBag.ServiceCategories)
                    {
                        <option value="@cat.CategoryID">@cat.ServiceType</option>
                    }
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Service Subtype</label>
                <select class="form-select subtype-select select2" data-prop="SubtypeID">
                    <option value="">Select Subtype</option>
                </select>
            </div>
                <input type="hidden" class="form-control appointment-date" data-prop="AppointmentDate" />
            <div class="col-md-6 date-time-group">
                <label class="form-label fw-semibold">Time</label>
                <select class="form-select timeSlots" data-prop="AppointmentTime"></select>
            </div>

            <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea class="form-control" data-prop="Notes">No notes.</textarea>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(function () {
            const allSubtypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ServiceSubtypes));
            const container = $("#appointmentsContainer");
            const template = document.getElementById("appointmentTemplate");
            const maxAppointments = 3;
            let appointmentCount = 0;
            let cachedPets = [];
            let pendingRemove = null;

            const params = new URLSearchParams(window.location.search);
            const dateParam = params.get("date");
            const timeParam = params.get("time");

            function showToast(msg, success = false) {
                const toastEl = $('#messageToast');
                const toastBody = toastEl.find('.toast-body');
                toastBody.text(msg);
                toastEl.removeClass('bg-success bg-danger').addClass(success ? 'bg-success' : 'bg-danger');
                new bootstrap.Toast(toastEl[0]).show();
            }

            function initSelect2(scope, placeholder = null) {
                $(scope).find(".select2").each(function () {
                    $(this).select2({
                        width: "100%",
                        placeholder: placeholder || $(this).data("placeholder") || "",
                        allowClear: true
                    });
                });
            }

            $("#ownerSelect").select2({
                placeholder: "-- Select Owner --",
                allowClear: true,
                width: "100%"
            }).on("change", function () {
                const ownerId = $(this).val();
                cachedPets = [];
                if (!ownerId) return;

                $.get("@Url.Action("GetPetsByOwner", "Staff")", { ownerId })
                    .done(pets => {
                        cachedPets = pets || [];
                        $(".pet-select").each(function () {
                            const s = $(this);
                            s.empty();
                            cachedPets.forEach(p => s.append(`<option value="${p.petID}">${p.name} (${p.type})</option>`));
                            s.select2({
                                placeholder: "-- Select Pet --",
                                allowClear: true,
                                width: "100%"
                            });
                        });
                    })
                    .fail(() => showToast("Error loading pets"));
            });

            $(document).on("change", ".category-select", function () {
                const id = $(this).val();
                const subtype = $(this).closest(".appointment-block").find(".subtype-select");
                subtype.empty();
                allSubtypes.filter(s => s.CategoryID == id)
                    .forEach(s => subtype.append(`<option value="${s.SubtypeID}">${s.ServiceSubType}</option>`));

                subtype.select2({
                    placeholder: "-- Select Subtype --",
                    allowClear: true,
                    width: "100%"
                });
            });

            function initSelect2(scope) {
                $(scope).find(".select2").each(function () {
                    const placeholder =
                        $(this).attr("data-prop") === "PetID" ? "-- Select Pet --" :
                        $(this).attr("data-prop") === "CategoryID" ? "-- Select Category --" :
                        $(this).attr("data-prop") === "SubtypeID" ? "-- Select Type --" : "";

                    $(this).select2({
                        width: "100%",
                        placeholder: placeholder,
                        allowClear: true
                    });
                });
            }

            function fetchSlots(dateInput, timeSelect, selectedTime = null) {
                const date = dateInput.val();
                if (!date) return;
                $.get("@Url.Action("GetAvailableTimeSlots", "Admin")", { date }).done(slots => {
                    timeSelect.empty();
                    if (slots?.length) {
                       const existingTimes = JSON.parse(localStorage.getItem("appointmentCart") || "[]").map(a => `${a.date}-${a.time}`);
                        slots.forEach(s => {
                            const isTaken = existingTimes.includes(`${date}-${s}`);
                            const text = isTaken ? `${s} (Added to List)` : s;
                            const opt = $("<option>", { value: s, text: text });
                            if (isTaken) opt.prop("disabled", true);
                            if (s === selectedTime) opt.attr("selected", true);
                            timeSelect.append(opt);
                        });
                    } else {
                        timeSelect.append("<option disabled>No slots available</option>");
                    }
                });
            }

            function areAllAppointmentsComplete() {
                let allComplete = true;
                $(".appointment-block").each(function () {
                    const block = $(this);
                    const pet = block.find("[data-prop='PetID']").val();
                    const cat = block.find("[data-prop='CategoryID']").val();
                    const subtype = block.find("[data-prop='SubtypeID']").val();
                    const notes = (block.find("[data-prop='Notes']").val() || "").trim();

                    const dateInput = block.find("[data-prop='AppointmentDate']");
                    const timeSelect = block.find("[data-prop='AppointmentTime']");
                    const dateEnabled = !dateInput.prop("disabled");
                    const timeEnabled = !timeSelect.prop("disabled");
                    const date = dateEnabled ? dateInput.val() : true;
                    const time = timeEnabled ? timeSelect.val() : true;

                    if (!pet && !cat && !subtype && notes.length === 0) return;

                    if (!pet || !cat || !subtype || !date || !time || notes.length === 0) {
                        allComplete = false;
                    }
                });
                return allComplete;
            }

                    function addAppointmentBlock() {
            if (appointmentCount >= maxAppointments) return showToast("You can only add up to 3 services per appointment.");
            appointmentCount++;

            const clone = template.content.cloneNode(true);
            const block = $(clone).find(".appointment-block");
            block.find("h6").text(`Service #${appointmentCount}`);
            block.find("[data-prop]").each(function () {
                const prop = $(this).data("prop");
                $(this).attr("name", `Appointments[${appointmentCount - 1}].${prop}`);
            });

            container.append(block);
            initSelect2(block);

            const petSelect = block.find(".pet-select");
            if (cachedPets.length > 0)
                cachedPets.forEach(p => petSelect.append(`<option value="${p.petID}">${p.name} (${p.type})</option>`));

            const dateInput = block.find(".appointment-date");
            const timeSelect = block.find(".timeSlots");

            if (appointmentCount === 1) {
                if (dateParam) dateInput.val(dateParam);
                fetchSlots(dateInput, timeSelect, timeParam);
            } else {
                const firstDate = $(".appointment-block").first().find(".appointment-date").val();
                const firstTime = $(".appointment-block").first().find(".timeSlots").val();

                dateInput.val(firstDate).prop("disabled", true);
                timeSelect.val(firstTime).prop("disabled", true);
                block.find(".date-time-group").hide();
            }
        }


            $("#addMoreAppointments").on("click", function () {
                if (!areAllAppointmentsComplete()) {
                    showToast("Please complete all fields before adding another service.", false);
                    return;
                }

                if (appointmentCount >= maxAppointments) {
                    showToast("Maximum 3 services only.", false);
                    return;
                }

                const modal = new bootstrap.Modal('#confirmAddModal');
                modal.show();

                $('#confirmAddBtn').off('click').on('click', function () {
                    modal.hide();
                    addAppointmentBlock();
                });
            });

            $(document).on("click", ".remove-appointment", function () {
                pendingRemove = $(this).closest(".appointment-block");
                new bootstrap.Modal('#confirmRemoveModal').show();
            });

            $("#confirmRemoveBtn").on("click", function () {
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmRemoveModal'));
                modal.hide();
                if (pendingRemove) {
                    pendingRemove.remove();
                    appointmentCount--;
                }
            });

            $("#addAppointmentForm").off("submit").on("submit", function (e) {
                e.preventDefault();

                const ownerId = $("#ownerSelect").val();
                if (!ownerId) return showToast("Please select an owner first");

                if (!areAllAppointmentsComplete()) {
                    return showToast("Please fill out all fields for every service (including notes).", false);
                }

                const modal = new bootstrap.Modal('#confirmSaveModal');
                modal.show();

                $('#confirmSaveBtn').off('click').on('click', function () {
                    modal.hide();
                    saveToCart();

                    /*
                    // Old DB direct save (disabled)
                    $.post($("#addAppointmentForm").attr("action"), $("#addAppointmentForm").serialize())
                        .done(res => {
                            showToast(res.message, res.success);
                            if (res.success)
                                setTimeout(() => window.location.href = "@@Url.Action("Appointments", "Admin")", 1000);
                        })
                        .fail(() => showToast("Failed to save appointments"));
                    */
                });
            });

            addAppointmentBlock(); // initialize first service block
                    function generateGroupDraftId() {
            return "Draft-" + Date.now() + "-" + Math.floor(Math.random() * 99999);
        }

            function saveToCart() {
            const ownerId = $("#ownerSelect").val();
            if (!ownerId) return showToast("Please select an owner first");

            let appointments = [];

            $(".appointment-block").each(function () {
                const block = $(this);
                const item = {
                    ownerID: ownerId,
                    petID: block.find("[data-prop='PetID']").val(),
                    petName: block.find("[data-prop='PetID'] option:selected").text() || "—",
                    categoryID: block.find("[data-prop='CategoryID']").val(),
                    categoryName: block.find("[data-prop='CategoryID'] option:selected").text() || "—",
                    subtypeID: block.find("[data-prop='SubtypeID']").val(),
                    subtypeName: block.find("[data-prop='SubtypeID'] option:selected").text() || "—",
                    date: block.find("[data-prop='AppointmentDate']").val(),
                    time: block.find("[data-prop='AppointmentTime']").val(),
                    appointmentDate: block.find("[data-prop='AppointmentDate']").val(),
                    appointmentTime: block.find("[data-prop='AppointmentTime']").val(),
                    notes: block.find("[data-prop='Notes']").val() || "No notes."
                };

                if (item.petID && item.categoryID && item.subtypeID && item.appointmentDate)
                    appointments.push(item);
            });

            if (appointments.length === 0)
                return showToast("Please fill out at least one valid appointment.", false);

           const groupDraftId = generateGroupDraftId();
           appointments.forEach(a => a.groupDraftId = groupDraftId);


            let existing = JSON.parse(localStorage.getItem("appointmentCart") || "[]");
            existing = existing.concat(appointments);
            localStorage.setItem("appointmentCart", JSON.stringify(existing));

            fetch("/Admin/SaveAppointmentDrafts", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify(appointments)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success)
                    showToast("Drafts saved to database!", true);
                else
                    showToast(data.message || "Failed to save drafts to DB.", false);
            })
            .catch(() => showToast("Error saving drafts to database.", false));

            showToast(`${appointments.length} appointment(s) added to cart!`, true);
            setTimeout(() => window.location.href = "@Url.Action("Appointments", "Admin")", 800);
        }



        });
    </script>
}
