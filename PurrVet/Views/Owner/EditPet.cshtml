@model PurrVet.Models.Pet
@{
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    ViewBag.Title = "Edit Pet";
    string fallback = Url.Content("~/uploads/profiles/pet.png");
    var photo = string.IsNullOrEmpty(Model.PhotoPath) ? fallback : Url.Content(Model.PhotoPath);
}

<div class="p-2">
    <a href="@Url.Action("Pets", "Owner")"
       class="btn btn-sm btn-view d-flex align-items-center justify-content-center"
       style="background-color:#FFAE34; border-radius:10px; width:36px; height:36px; font-size:20px;">
        <i class="bi bi-chevron-left text-black" style="position: relative; top: 2px;"></i>
    </a>

    <div class="text-center mb-3">
        <img id="petPreview" src="@photo" alt="@Model.Name"
             class="rounded shadow-sm"
             style="width:180px; height:180px; object-fit:cover; border-radius:14px;"
             onerror="this.onerror=null;this.src='@fallback';" />
        <h3 class="fw-bold mt-3">@Model.Name</h3>
    </div>

    <div class="card shadow-sm p-3 rounded-4">
        <form id="editPetForm" method="post" enctype="multipart/form-data" asp-action="EditPet" asp-controller="Owner">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.PetID" />

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Pet Name</label>
                    <input name="Name" id="Name" value="@Model.Name" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Type</label>
                    <select name="Type" id="Type" class="form-select" required>
                        <option value="">-- Select Type --</option>
                        <option value="Dog" selected=@(Model.Type == "Dog" ? "selected" : null)>Dog</option>
                        <option value="Cat" selected=@(Model.Type == "Cat" ? "selected" : null)>Cat</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Breed</label>
                    <select name="Breed" id="Breed" class="form-select">
                        <option value="@Model.Breed">@Model.Breed</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Birthdate</label>
                    <input type="date" name="Birthdate" id="Birthdate"
                           value="@(Model.Birthdate.ToString("yyyy-MM-dd"))"
                           class="form-control" />
                </div>

                <div class="col-12">
                    <label class="form-label fw-semibold">Photo (optional)</label>
                    <input type="file" name="Photo" id="Photo" accept="image/*" class="form-control" onchange="previewPetImage(event)" />
                </div>
            </div>

            <div id="formErrors" class="text-danger mt-3"></div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" id="saveBtn" class="btn btn-success px-4">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
    <div id="messageToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-semibold"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-warning text-white rounded-top-4">
                <h6 class="modal-title fw-bold" id="confirmModalLabel">Confirm</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-0 fw-semibold">Save changes to this pet?</p>
            </div>
            <div class="modal-footer justify-content-end border-0">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSaveBtn" class="btn btn-success rounded-pill px-4">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#Type, #Breed').select2({
                placeholder: "-- Select --",
                allowClear: true,
                width: '100%'
            });

            // Auto-load breeds when editing
            const currentType = $('#Type').val();
            if (currentType) {
                loadBreeds(currentType, '@Model.Breed');
            }

            $('#Type').on('change', function () {
                const type = $(this).val();
                loadBreeds(type, null);
            });

            function loadBreeds(type, selectedBreed) {
                const breedSelect = $('#Breed');
                breedSelect.empty().append('<option value="">-- Select Breed --</option>');

                if (!type) return;

                $.ajax({
                    url: '@Url.Action("GetBreeds", "Owner")',
                    type: 'GET',
                    data: { type: type },
                    success: function (breeds) {
                        $.each(breeds, function (i, breed) {
                            breedSelect.append('<option value="' + breed + '">' + breed + '</option>');
                        });
                        // Refresh select2 dropdown
                        breedSelect.val(selectedBreed).trigger('change.select2');
                    }
                });
            }
                $('#editPetForm').on('submit', function (e) {
            e.preventDefault();
            $('#saveBtn').click();
        });
            $('#saveBtn').on('click', function () {
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();

                $('#confirmSaveBtn').off('click').on('click', function () {
                    modal.hide();

                    const name = $('#Name').val().trim();
                    const type = $('#Type').val().trim();
                    if (!name || !type) {
                        $('#formErrors').html('Name and Type are required.');
                        return;
                    }

                    const formEl = document.getElementById('editPetForm');
                    const formData = new FormData(formEl);

                    $.ajax({
                        url: '@Url.Action("EditPet", "Owner")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            showToast(res.message, res.success);
                            if (res.success) {
                                setTimeout(function () {
                                    window.location.href = '@Url.Action("Pets", "Owner")';
                                }, 1200);
                            }
                        },
                        error: function () {
                            showToast("Something went wrong while saving.", false);
                        }
                    });
                });
            });
        });

        function previewPetImage(event) {
            const reader = new FileReader();
            reader.onload = () => document.getElementById('petPreview').src = reader.result;
            reader.readAsDataURL(event.target.files[0]);
        }

        function showToast(message, success = true) {
            const toastEl = $('#messageToast');
            const toastBody = toastEl.find('.toast-body');
            toastBody.text(message);
            toastEl.removeClass('bg-success bg-danger').addClass(success ? 'bg-success' : 'bg-danger');
            new bootstrap.Toast(toastEl[0], { delay: 2500 }).show();
        }
    </script>
}
