@{
    ViewBag.Title = "Add Pet";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="p-4">
    <h5 class="mb-4 fw-bold">My Pets / Add New Pet</h5>

    <div class="card shadow-sm p-4">
        <h4 class="mb-3 fw-bold">Add Pet</h4>
        <hr class="mb-4" />

        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
            <div id="messageToast" class="toast align-items-center text-white border-0 shadow"
                 role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <form id="addPetForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <div class="row g-3">

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Name</label>
                    <input type="text" name="Name" class="form-control" placeholder="Enter pet name" />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Type</label>
                    <select name="Type" class="form-select">
                        <option value="">-- Select Type --</option>
                        <option value="Dog">Dog</option>
                        <option value="Cat">Cat</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Breed</label>
                    <select name="Breed" class="form-select">
                        <option value="">-- Select Breed --</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Birthdate</label>
                    <input type="date" name="Birthdate" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Photo</label>

                    <div id="photoBox"
                         class="border rounded d-flex align-items-center justify-content-center bg-light mb-2"
                         style="height: 200px; width: 100%; overflow: hidden;">
                        <img id="photoPreview" src="/images/default-pet.png"
                             alt="Preview"
                             class="img-fluid d-none"
                             style="max-height: 100%; object-fit: cover;" />
                        <span id="photoPlaceholder" class="text-muted">No image selected</span>
                    </div>

                    <input type="file" name="Photo" accept="image/*"
                           class="form-control" id="photoInput" />
                </div>

            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary px-4">Save</button>
                <a href="@Url.Action("Pets", "Owner")" class="btn btn-secondary px-4">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmSaveModal" tabindex="-1"
     aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title fw-bold" id="confirmSaveModalLabel">Confirm Add Pet</h6>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fw-semibold mb-0">Are you sure you want to add this pet?</p>
            </div>
            <div class="modal-footer d-flex justify-content-end">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSaveBtn" class="btn btn-success px-4">Confirm</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(function () {
            $('select[name="Type"], select[name="Breed"]').select2({
                placeholder: "-- Select --",
                allowClear: true,
                width: '100%'
            });

            $('select[name="Type"]').on('change', function () {
                var type = $(this).val();
                var breedSelect = $('select[name="Breed"]');
                breedSelect.empty().append('<option value="">-- Select Breed --</option>');
                if (!type) return;

                $.ajax({
                    url: '/Admin/GetBreeds',
                    data: { type: type },
                    success: function (breeds) {
                        $.each(breeds, function (i, breed) {
                            breedSelect.append('<option value="' + breed + '">' + breed + '</option>');
                        });
                        breedSelect.trigger('change');
                    }
                });
            });

            const toastEl = $('#messageToast');
            const toastBody = toastEl.find('.toast-body');

            function showToast(message, isSuccess) {
                toastBody.text(message);
                toastEl.removeClass('bg-success bg-danger')
                    .addClass(isSuccess ? 'bg-success' : 'bg-danger');
                new bootstrap.Toast(toastEl[0], { delay: 3000 }).show();
            }

            $('#photoInput').on('change', function (e) {
                const file = e.target.files[0];
                const preview = $('#photoPreview');
                const placeholder = $('#photoPlaceholder');

                if (file) {
                    const img = new Image();
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        img.src = event.target.result;
                    };

                    img.onload = function () {
                        const width = img.width;
                        const height = img.height;

                        if (width < 300 || height < 300) {
                            showToast("Image must be at least 300x300 pixels.", false);
                            $('#photoInput').val('');
                            preview.addClass('d-none');
                            placeholder.removeClass('d-none').text('No image selected');
                            return;
                        }

                        preview.attr('src', img.src).removeClass('d-none');
                        placeholder.addClass('d-none');
                    };

                    reader.readAsDataURL(file);
                } else {
                    preview.addClass('d-none');
                    placeholder.removeClass('d-none').text('No image selected');
                }
            });

            $('#addPetForm').on('submit', function (e) {
                e.preventDefault();

                const modal = new bootstrap.Modal(document.getElementById('confirmSaveModal'));
                modal.show();

                $('#confirmSaveBtn').off('click').on('click', function () {
                    modal.hide();

                    const name = $('input[name="Name"]').val().trim();
                    const type = $('select[name="Type"]').val();
                    const birth = $('input[name="Birthdate"]').val();

                    if (!name || !type || !birth) {
                        showToast("Please fill in all required fields before saving.", false);
                        return;
                    }

                    const formData = new FormData($('#addPetForm')[0]);

                    $.ajax({
                        url: '/Owner/Add',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            showToast(res.message, res.success);
                            if (res.success) {
                                $('#addPetForm')[0].reset();
                                $('#photoPreview').addClass('d-none');
                                $('#photoPlaceholder').removeClass('d-none').text('No image selected');
                                $('select').val(null).trigger('change');
                                setTimeout(() => window.location.href = '/Owner/Pets', 1200);
                            }
                        },
                        error: function () {
                            showToast("Something went wrong. Please try again later.", false);
                        }
                    });
                });
            });
        });
    </script>
}
