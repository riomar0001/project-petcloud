@model List<PurrVet.Models.Appointment>
@Html.AntiForgeryToken()
@{
    Layout = "~/Views/Shared/_DashboardLayoutModern.cshtml";
    ViewBag.Title = "My Appointments";
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
<link href="/css/appointment.css" rel="stylesheet" />

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="syncToast" class="toast toast-modern align-items-center text-white border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center gap-2">
                <i class="bi" id="syncToastIcon"></i>
                <span id="syncToastMessage">Syncing appointments...</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Confirm Sync Modal -->
<div class="modal fade modal-modern" id="confirmSyncModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">
                    <i class="bi bi-cloud-arrow-up"></i>
                    Confirm Sync
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-calendar-check display-1 text-primary opacity-75"></i>
                </div>
                <p class="fw-semibold fs-5 mb-2">Sync All Appointments?</p>
                <small class="text-muted">This will sync all your appointments to Microsoft Outlook</small>
            </div>
            <div class="modal-footer">
                <button class="btn-modern-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </button>
                <button class="btn-modern-success" id="confirmSyncBtn">
                    <i class="bi bi-cloud-arrow-up me-1"></i> Yes, Sync Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Max Pending Modal -->
<div class="modal fade modal-modern modal-danger" id="maxPendingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Cannot Schedule Appointment
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-calendar-x display-1 text-danger opacity-75"></i>
                </div>
                <p class="fw-semibold fs-5 mb-2">Maximum Pending Appointments Reached</p>
                <p class="text-muted mb-0">You already have <strong>3 pending appointment requests.</strong></p>
                <small class="text-muted">Please contact the clinic staff to manage your schedule before booking more.</small>
            </div>
            <div class="modal-footer">
                <button class="btn-modern-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-1"></i> OK
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Request Modal -->
<div class="modal fade modal-modern modal-danger" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">
                    <i class="bi bi-calendar-x"></i>
                    Request Appointment Cancellation
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <div class="form-group-modern">
                    <label>
                        <i class="bi bi-chat-text me-2"></i>
                        Reason for Cancellation
                    </label>
                    <textarea id="cancelNotes" class="form-control form-control-modern" rows="3" 
                              placeholder="Please provide a reason for your cancellation request..."></textarea>
                    <input type="hidden" id="cancelAppointmentId" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modern-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Close
                </button>
                <button class="btn-modern-danger" onclick="submitCancelRequest()">
                    <i class="bi bi-send me-1"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<div class="d-flex flex-column" style="height: calc(100vh - 100px);">
    <!-- Dashboard Header -->
    <div class="dashboard-header mb-3">
        <h2>My Appointments</h2>
        <p>View and manage your scheduled appointments</p>
    </div>

    @* <!-- Sync Toggle Card -->
    <div class="page-card-modern mb-3">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="sync-icon-container">
                        <i class="bi bi-microsoft text-primary fs-4"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-0">Microsoft Calendar Sync</h6>
                        <small class="text-muted">Auto-sync appointments to Outlook</small>
                    </div>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="syncToggle" onchange="toggleSync(this)" 
                           style="width: 3rem; height: 1.5rem; cursor: pointer;">
                </div>
            </div>
        </div>
    </div> *@

    <!-- Main Content Area -->
    <div class="d-flex flex-grow-1 gap-3" style="margin-inline: 24px;">
        <!-- Sidebar -->
        <div class="">
            <div class="page-card-modern-apt-dtls">
                <div class="card-header-modern">
                    <h6><i class="bi bi-calendar3 me-2"></i>DATE PICKER</h6>
                </div>
                <div id="mini-calendar"></div>
            </div>

            <div class="page-card-modern-apt-dtls">
                <div class="card-header-modern" style="padding: 12px 16px;">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-info-circle"></i>
                        <span class="fw-bold">Appointment Details</span>
                    </div>
                </div>
                <div class="card-body" id="details-content" style="padding: 16px;">
                    <p class="text-muted mb-0">Select an appointment</p>
                </div>
            </div>

        </div>
        <!-- Calendar -->
        <div class="flex-grow-1 p-3 bg-white shadow-sm ms-3 rounded">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script>
    function showConfirmSyncModal() {
        const modal = new bootstrap.Modal(document.getElementById('confirmSyncModal'));
        modal.show();
        document.getElementById('confirmSyncBtn').onclick = function () {
            modal.hide();
            syncAllAppointments();
        };
    }

    function showToast(message, type = 'info') {
        const toastEl = document.getElementById('syncToast');
        const toastMessage = document.getElementById('syncToastMessage');
        const toastIcon = document.getElementById('syncToastIcon');
        
        toastMessage.textContent = message;
        
        // Set icon and class based on type
        let iconClass = 'bi-info-circle-fill';
        let toastClass = 'toast-modern';
        
        if (type === 'success') {
            iconClass = 'bi-check-circle-fill';
            toastClass = 'toast-modern toast-success';
        } else if (type === 'danger') {
            iconClass = 'bi-exclamation-circle-fill';
            toastClass = 'toast-modern toast-danger';
        } else if (type === 'primary') {
            iconClass = 'bi-cloud-arrow-up-fill';
            toastClass = 'toast-modern toast-success';
        }
        
        toastIcon.className = 'bi ' + iconClass;
        toastEl.className = 'toast ' + toastClass + ' align-items-center text-white border-0';
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const allAppointments = [
            @for (int i = 0; i < Model.Count; i++)
            {
                    var appt = Model[i];
                    var isCurrentOwner = appt.Pet?.OwnerID == Context.Session.GetInt32("OwnerID");
                    var status = appt.Status?.ToLower() ?? "";
                    var title = isCurrentOwner
                            ? (appt.GroupID != null ? $"Group Appointment #{appt.GroupID}" : appt.ServiceCategory?.ServiceType ?? "Service")
                            : "Not Available";

                    <text>
                    {
                        id: '@appt.AppointmentID',
                        title: '@Html.Raw(title)',
                        start: '@appt.AppointmentDate.ToString("yyyy-MM-ddTHH:mm:ss")',
                        allDay: false,
                        backgroundColor: '@(isCurrentOwner
                                                    ? (status == "pending" ? "#0dcaf0"
                                                    : status == "approved" ? "#198754"
                                                    : status == "cancelled" ? "#dc3545"
                                                    : status == "completed" ? "#20c997"
                                                    : status == "missed" ? "#dc3545"
                                                    : "#6c757d")
                                                    : "#dc3545")',                      /* red for others */
                    borderColor: '@(isCurrentOwner ? "#0dcaf0" : "#dc3545")',
                    textColor: 'white',
                    extendedProps: {
                        petName: '@Html.Raw(appt.Pet?.Name)',
                        category: '@Html.Raw(appt.ServiceCategory?.ServiceType)',
                        subtype: '@Html.Raw(appt.ServiceSubtype?.ServiceSubType)',
                        status: '@Html.Raw(appt.Status)',
                        notes: '@Html.Raw(appt.Notes)',
                        groupID: '@appt.GroupID',
                        ownerID: '@appt.Pet?.OwnerID'
                    }
                }@(i < Model.Count - 1 ? "," : "")
                </text>
                        }
        ];

        const limitedAppointments = allAppointments;

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            height: '100%',
            slotMinTime: '09:00:00',
            slotMaxTime: '18:30:00',
            expandRows: true,
            slotDuration: '00:05:00',
            eventOverlap: false,
            headerToolbar: {
                left: 'prev,next title',
                center: '',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            allDaySlot: false,
            selectable: true,
            eventTimeFormat: {
                hour: 'numeric',
                minute: '2-digit',
                meridiem: 'short',
                hour12: true
            },
            events: limitedAppointments,

            eventDidMount: function (info) {
                if (info.event.extendedProps.ownerID != @Context.Session.GetInt32("OwnerID")) {
                    info.el.style.backgroundColor = '#dc3545';
                    info.el.style.borderColor = '#dc3545';
                    info.el.style.color = 'white';
                }
            },

            eventContent: function (arg) {
                const e = arg.event;
                const timeStr = e.start
                    ? e.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })
                    : '';
                const label = e.extendedProps.ownerID != @Context.Session.GetInt32("OwnerID")
                    ? "Not Available"
                    : e.title;
                const style = "color:white;font-weight:600;font-size:9px;line-height:0.9;";
                return { html: `<div style="${style}">${label}</div><div style="${style}">${timeStr}</div>` };
            },

            eventClick: function (info) {
                const e = info.event;
                const detailsDiv = document.getElementById('details-content');
                const groupID = e.extendedProps.groupID;
                let currentGroupEvents = calendar.getEvents().filter(ev => ev.extendedProps.groupID === groupID);
                let currentGroupIndex = currentGroupEvents.findIndex(ev => ev.id === e.id);

                if (e.extendedProps.ownerID != @Context.Session.GetInt32("OwnerID")) {
                    detailsDiv.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-calendar-x display-4 text-danger opacity-75"></i>
                            <p class="mt-2 fw-semibold text-danger">This slot is <strong>Not Available</strong>.</p>
                        </div>`;
                    return;
                }

                function renderDetails(event) {
                    let statusBadge = "";
                    switch (event.extendedProps.status?.toLowerCase()) {
                        case "completed": statusBadge = '<span class="badge-modern badge-active">Completed</span>'; break;
                        case "missed": statusBadge = '<span class="badge-modern badge-inactive">Missed</span>'; break;
                        case "cancelled": statusBadge = '<span class="badge-modern badge-inactive">Cancelled</span>'; break;
                        case "pending": statusBadge = '<span class="badge-modern badge-pending">Pending</span>'; break;
                        case "approved": statusBadge = '<span class="badge-modern badge-active">Approved</span>'; break;
                        case "requested": statusBadge = '<span class="badge-modern badge-pending">Requested</span>'; break;
                        default: statusBadge = '<span class="badge-modern">' + (event.extendedProps.status || 'Unknown') + '</span>';
                    }

                    let buttons = "";
                    if (event.extendedProps.status?.toLowerCase() === "requested") {
                        buttons += `<a href="/Owner/EditAppointment/${event.id}" class="btn-modern-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit</a>`;
                    }
                    if (["pending", "requested"].includes(event.extendedProps.status?.toLowerCase())) {
                        buttons += `<button class="btn-modern-danger btn-sm" onclick="requestCancellation(${event.id})"><i class="bi bi-x-circle me-1"></i>Cancel</button>`;
                    }

                    detailsDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prevGroupBtn" class="btn-modern-secondary btn-sm" style="padding: 6px 12px;">
                               <i class="bi bi-chevron-left"></i>
                            </button>
                            <span class="badge-modern badge-type-appointment">${currentGroupIndex + 1} of ${currentGroupEvents.length}</span>
                            <button id="nextGroupBtn" class="btn-modern-secondary btn-sm" style="padding: 6px 12px;">
                               <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        <div class="info-item-modern mb-2">
                            <div class="info-label"><i class="bi bi-heart-pulse me-2"></i>Pet</div>
                            <div class="info-value">${event.extendedProps.petName || 'N/A'}</div>
                        </div>
                        <div class="info-item-modern mb-2">
                            <div class="info-label"><i class="bi bi-tag me-2"></i>Category</div>
                            <div class="info-value">${event.extendedProps.category || 'N/A'}</div>
                        </div>
                        <div class="info-item-modern mb-2">
                            <div class="info-label"><i class="bi bi-bookmark me-2"></i>Subtype</div>
                            <div class="info-value">${event.extendedProps.subtype || 'N/A'}</div>
                        </div>
                        <div class="info-item-modern mb-2">
                            <div class="info-label"><i class="bi bi-calendar-event me-2"></i>Date</div>
                            <div class="info-value">${event.start.toLocaleString()}</div>
                        </div>
                        <div class="info-item-modern mb-2">
                            <div class="info-label"><i class="bi bi-flag me-2"></i>Status</div>
                            <div class="info-value">${statusBadge}</div>
                        </div>
                        <div class="info-item-modern mb-3">
                            <div class="info-label"><i class="bi bi-chat-text me-2"></i>Notes</div>
                            <div class="info-value">${event.extendedProps.notes || 'No notes'}</div>
                        </div>
                        <div class="d-flex gap-2 justify-content-end">${buttons}</div>
                    `;

                    document.getElementById('prevGroupBtn').onclick = () => {
                        if (currentGroupIndex > 0) {
                            currentGroupIndex--;
                            renderDetails(currentGroupEvents[currentGroupIndex]);
                        }
                    };
                    document.getElementById('nextGroupBtn').onclick = () => {
                        if (currentGroupIndex < currentGroupEvents.length - 1) {
                            currentGroupIndex++;
                            renderDetails(currentGroupEvents[currentGroupIndex]);
                        }
                    };
                }

                if (currentGroupIndex === -1) currentGroupIndex = 0;
                renderDetails(currentGroupEvents[currentGroupIndex]);
            },

            dateClick: function (info) {
                const now = new Date();

                if (info.date < now) {
                    showToast("Cannot schedule in the past.", "danger");
                    return;
                }

                const detailsDiv = document.getElementById('details-content');
                if (info.view.type === "dayGridMonth") return;
                const date = info.date;
                const formattedDate = date.toISOString().split('T')[0];
                const formattedTime = date.toTimeString().slice(0, 5);
                detailsDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-plus display-4 text-success opacity-75"></i>
                        <p class="mt-3 text-muted mb-3">No appointment for <strong>${date.toLocaleString()}</strong></p>
                        <button class="btn-modern-success" onclick="scheduleAppointment('${formattedDate}', '${formattedTime}')">
                            <i class="bi bi-plus-circle me-1"></i> Schedule Appointment
                        </button>
                    </div>
                `;
            }
        });

        calendar.render();

        flatpickr("#mini-calendar", {
            inline: true,
            dateFormat: "D",
            minDate: "today",
            onChange: function (selectedDates) {
                calendar.gotoDate(selectedDates[0]);
            }
        });

    });

    let isSyncEnabled = sessionStorage.getItem("syncEnabled") === "true";

    document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.getElementById("syncToggle");
        if (toggle) toggle.checked = isSyncEnabled;
        if (isSyncEnabled) {
            showToast("Auto Sync is active. Checking for new appointments...", "primary");
            syncAllAppointments();
        }
        setInterval(() => {
            if (isSyncEnabled) syncAllAppointments();
        }, 3 * 60 * 1000);
    });

    function toggleSync(element) {
        isSyncEnabled = element.checked;
        sessionStorage.setItem("syncEnabled", isSyncEnabled);
        if (isSyncEnabled) {
            showToast("Auto Sync enabled. Syncing all appointments...", "primary");
            syncAllAppointments();
        } else {
            showToast("Auto Sync disabled. New appointments will not sync.", "danger");
        }
    }

    async function syncAllAppointments() {
        showToast("Syncing appointments...", "primary");
        const res = await fetch('/Owner/SyncAppointments', {
            method: "POST",
            headers: {
                "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value || "",
                "Content-Type": "application/json"
            }
        });
        const data = await res.json();
        showToast(
            data.message || (data.success ? "Appointments synced successfully!" : "Some appointments failed to sync."),
            data.success ? "success" : "danger"
        );
    }

    function scheduleAppointment(date, time) {
        const pending = @ViewBag.PendingGroupCount;

        if (pending >= 3) {
            const modal = new bootstrap.Modal(document.getElementById("maxPendingModal"));
            modal.show();
            return;
        }

        window.location.href = `/Owner/AddAppointment?date=${date}&time=${time}`;
    }


        function requestCancellation(id) {
        document.getElementById("cancelNotes").value = "";
        document.getElementById("cancelAppointmentId").value = id;
        new bootstrap.Modal(document.getElementById("cancelModal")).show();
    }

          async function submitCancelRequest() {
        const id = document.getElementById("cancelAppointmentId").value;
        const notes = document.getElementById("cancelNotes").value.trim();
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        if (!notes) {
            showToast("Please enter a reason for cancellation.", "danger");
            return;
        }

        try {
            const res = await fetch(`/Owner/RequestCancellation/${id}`, {
                method: "POST",
                headers: {
                    "RequestVerificationToken": token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ notes })
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById("cancelModal"));
            modal.hide(); 

            if (!res.ok) {
                showToast("Something went wrong. Please try again.", "danger");
                return;
            }

            const data = await res.json();
            showToast(data.message, data.success ? "success" : "danger");

            if (data.success) {
                document.getElementById("cancelNotes").value = "";
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            const modal = bootstrap.Modal.getInstance(document.getElementById("cancelModal"));
            modal.hide(); 

            showToast("Failed to submit request. Please check your connection.", "danger");
            console.error("Cancel error:", error);
        }
    }

</script>

