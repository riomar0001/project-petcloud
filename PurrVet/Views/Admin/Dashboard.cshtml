@model PurrVet.Models.DashboardViewModel

@{
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    ViewBag.Title = "Dashboard";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="~/css/cards.css" rel="stylesheet" />

<div class="container-fluid p-4">

    <div class="row g-4 mb-4">

        <div class="col-md-4">
            <div class="metric-card-new">
                <div class="divider-line"></div>
                <div class="metric-body">
                    <div class="metric-left">
                        <i class="bi bi-people-fill card-icon"></i>
                        <div class="metric-label">Total Users</div>
                    </div>
                    <div class="metric-value" id="usersCount">@Model.TotalUsers</div>
                </div>
                <div class="orange-bar"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="metric-card-new">
                <div class="divider-line"></div>
                <div class="metric-body">
                    <div class="metric-left">
                        <i class="fa fa-paw card-icon"></i>
                        <div class="metric-label">Total Pets</div>
                    </div>
                    <div class="metric-value" id="petsCount">@Model.TotalPets</div>
                </div>
                <div class="orange-bar"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="metric-card-new">
                <div class="divider-line"></div>
                <div class="metric-body">
                    <div class="metric-left">
                        <i class="bi bi-calendar-check card-icon"></i>
                        <div class="metric-label">Total Appointments</div>
                    </div>
                    <div class="metric-value" id="appointmentsCount">@Model.TotalAppointments</div>
                </div>
                <div class="orange-bar"></div>
            </div>
        </div>

    </div>


    <div class="row g-4">
        <div class="col-lg-9">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <strong>Monthly Overview</strong>
                        <div class="text-muted small">Total numbers per month</div>
                    </div>
                    <div class="d-flex gap-2">
                        <select id="dataType" class="filter-select">
                            <option value="Users">Users</option>
                            <option value="Appointments">Appointments</option>
                            <option value="Pets">Pets</option>
                        </select>
                        <select id="yearSelect" class="filter-select">
                            @foreach (var year in Model.Years)
                            {
                                <option value="@year" selected=@(year == DateTime.Now.Year ? "selected" : "")>@year</option>
                            }
                        </select>
                    </div>
                </div>
                <div style="height:400px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="forecast-card mb-3">
                <div class="forecast-header">Monthly Totals</div>
                <div class="divider-line"></div>
                <div class="px-3 forecast-list" id="monthlyTotalsList"></div>
            </div>

            <div class="forecast-card">
                <div class="forecast-header">Highlights</div>
                <div class="px-3 forecast-list" id="monthlyHighlightsList"></div>
            </div>
        </div>
    </div>
</div>

<div class="mt-1">
    <div class="card shadow-sm border-0 m-lg-3">
        <div class="card-header d-flex justify-content-between align-items-center bg-white py-2 px-3">
            <h6 class="mb-0 fw-bold text-secondary">
                <i class="bi bi-bell me-2 text-primary"></i> Recent Notifications
            </h6>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive" style=" max-height: 200px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light sticky-top small text-secondary">
                        <tr>
                            <th style="width: 55%">Message</th>
                            <th style="width: 20%">Type</th>
                            <th style="width: 25%">Date</th>
                        </tr>
                    </thead>
                    <tbody id="notificationList" class="small">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer text-center bg-white py-2">
            <a href="@Url.Action("AdminNotification", "Admin")"
               class="text-primary fw-semibold small text-decoration-none">
                See all notifications
            </a>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
        let chart;
        function loadMonthlyData(type, year) {
            $.getJSON('/Admin/GetMonthlyTotals', { type: type, year: year }, function (data) {
                const labels = data.map(d => d.month);
                const counts = data.map(d => d.count);
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${type} per Month (${year})`,
                            data: counts,
                            borderColor: '#004085',
                            backgroundColor: 'rgba(0,64,133,0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                $("#monthlyTotalsList").empty();
                $("#monthlyHighlightsList").empty();

                data.forEach(d => {
                    $("#monthlyTotalsList").append(`
                        <div class="d-flex justify-content-between align-items-center py-2">
                            <h6 class="mb-0 fw-semibold">${d.month}</h6>
                            <h6 class="mb-0 fw-bold">${d.count}</h6>
                        </div>
                    `);
                });

                if (data.length > 0) {
                    const max = data.reduce((a, b) => a.count > b.count ? a : b);
                    const min = data.reduce((a, b) => a.count < b.count ? a : b);

                    $("#monthlyHighlightsList").append(`
                        <div class="py-2">
                            <div class="fw-semibold text-success">📈 Highest</div>
                            <div>${max.month}: <strong>${max.count}</strong></div>
                        </div>
                        <div class="divider-line my-2"></div>
                        <div class="py-2">
                            <div class="fw-semibold text-danger">📉 Lowest</div>
                            <div>${min.month}: <strong>${min.count}</strong></div>
                        </div>
                    `);
                }
            });
        }

        function loadTotals(year) {
            $.getJSON('/Admin/GetTotalsData', { year: year }, function (data) {
                $("#usersCount").text(data.users);
                $("#petsCount").text(data.pets);
                $("#appointmentsCount").text(data.appointments);
            });
        }


        $("#dataType, #yearSelect").change(function () {
            loadMonthlyData($("#dataType").val(), $("#yearSelect").val());
        });

        $("#usersYear, #petsYear, #appointmentsYear").change(function () {
            loadTotals($(this).val());
        });

        loadMonthlyData("Users", new Date().getFullYear());

            function loadNotifications() {
        $.getJSON('/Admin/GetNotifications', function (data) {
            const notifications = data.notifications || [];
            const tableBody = $("#notificationList");
            tableBody.empty();

            if (notifications.length === 0) {
                tableBody.append(`
                    <tr>
                        <td colspan="3" class="text-center text-muted py-3">
                            No notifications
                        </td>
                    </tr>
                `);
                return;
            }

            notifications.forEach(n => {
                let iconHtml = "";
                const readClass = n.isRead ? "text-muted" : "fw-semibold text-dark table-primary";

                if (n.type === "User") {
                    iconHtml = `<i class="bi bi-person-plus text-primary me-2"></i>`;
                } else if (n.type === "Pet") {
                    iconHtml = `<i class="fa fa-paw text-primary me-2"></i>`;
                } else {
                    iconHtml = `<i class="bi bi-calendar-check text-primary me-2"></i>`;
                }

                tableBody.append(`
                    <tr class="${readClass}">
                        <td class="text-start">${iconHtml}${n.message}</td>
                        <td class="text-capitalize">${n.type}</td>
                        <td class="text-muted small">${n.createdAt}</td>
                    </tr>
                `);
            });
        });
    }

            $("#markAllReadPage").click(function () {
        $.post('/Admin/MarkAllNotificationsRead', function (res) {
            if (res.success) {
                loadNotifications();
            }

            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white border-0 position-fixed bottom-0 end-0 m-3 ${res.success ? 'bg-success' : 'bg-warning'}`;
            toastEl.role = 'alert';
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${res.message || (res.success ? "All notifications marked as read." : "No unread notifications.")}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            document.body.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            setTimeout(() => toastEl.remove(), 5000);
        });
    });


        loadNotifications();
    });
</script>
