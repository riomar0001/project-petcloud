@model PurrVet.Models.Appointment

@{
    ViewBag.Title = "Appointments";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="p-4">
    <h5 class="mb-4 fw-bold">Appointments / Edit Appointment</h5>
    <div class="card shadow-sm p-4">

        <!-- Toast -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
            <div id="messageToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <h4 class="mb-3 fw-bold">Edit Appointment</h4>
        <hr class="mb-4">

        <form id="editAppointmentForm" method="post" action="@Url.Action("EditAppointment", "Admin")">
            @Html.AntiForgeryToken()
            <input type="hidden" name="AppointmentID" value="@Model.AppointmentID" />

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Pet</label>
                    <select name="PetID" class="form-select" required>
                        @foreach (var pet in ViewBag.Pets)
                        {
                            <option value="@pet.PetID" selected=@(Model.PetID == pet.PetID ? "selected" : null)>
                                @pet.Name | @pet.Type (@pet.Owner.Name)
                            </option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Service Category</label>
                    <select id="CategoryID" name="CategoryID" class="form-select" required>
                        <option value="">-- Select Category --</option>
                        @foreach (var category in ViewBag.ServiceCategories)
                        {
                            <option value="@category.CategoryID" selected=@(Model.CategoryID == category.CategoryID ? "selected" : null)>
                                @category.ServiceType
                            </option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Service Subtype</label>
                    <select id="SubtypeID" name="SubtypeID" class="form-select" required>
                        <option value="">-- Select Subtype --</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Date</label>
                    <input type="date" name="AppointmentDate" class="form-control"
                           value="@(Model.AppointmentDate != default ? Model.AppointmentDate.ToString("yyyy-MM-dd") : "")" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Time</label>
                    <select name="AppointmentTime" class="form-select" id="timeSlots" required>
                        @if (Model.AppointmentDate != default)
                        {
                            <option value="@Model.AppointmentDate.ToString("HH:mm")">
                                @Model.AppointmentDate.ToString("hh:mm tt")
                            </option>
                        }
                        else
                        {
                            <option value="">-- Select Time --</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Status</label>
                    <select name="Status" class="form-select">
                        <option value="Missed" selected=@(Model.Status == "Missed" ? "selected" : null)>Missed</option>
                        <option value="Completed" selected=@(Model.Status == "Completed" ? "selected" : null)>Completed</option>
                        <option value="Cancelled" selected=@(Model.Status == "Cancelled" ? "selected" : null)>Cancelled</option>
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label fw-semibold">Notes</label>
                    <textarea name="Notes" class="form-control">@Model.Notes</textarea>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary px-4">Update</button>
                <a href="@Url.Action("Appointments", "Admin")" class="btn btn-secondary px-4">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title fw-bold" id="confirmSaveModalLabel">Appointment</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-0 fw-semibold">Are you sure you want to save the changes?</p>
            </div>
            <div class="modal-footer d-flex justify-content-end">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSaveBtn" class="btn btn-success px-4">Confirm</button>
            </div>
        </div>
    </div>
</div>

@using System.Text.Json

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    const urlParams = new URLSearchParams(window.location.search);
    const date = urlParams.get('date');
    const time = urlParams.get('time');

    if (date) $('input[name="AppointmentDate"]').val(date);
    if (time) $('#timeSlots').append(`<option selected value="${time}">${time}</option>`);

    $('select[name="PetID"], select[name="CategoryID"], select[name="SubtypeID"], select[name="Status"]').select2({
        placeholder: "-- Select --",
        allowClear: true,
        width: '100%'
    });

    const allSubtypes = @Html.Raw(JsonSerializer.Serialize(ViewBag.ServiceSubtypesJson));
    const subtypeSelect = $('#SubtypeID');
    const categorySelect = $('#CategoryID');
    const modelCategory = '@Model.CategoryID';
    const modelSubtype = '@Model.SubtypeID';
    const modelTime = '@Model.AppointmentDate.ToString("HH:mm")';

    function populateSubtypes(categoryId, selectedSubtypeId) {
        subtypeSelect.empty().append('<option value="">-- Select Subtype --</option>');
        if (!categoryId) return;

        const filtered = JSON.parse(allSubtypes).filter(s => s.CategoryID == categoryId);
        if (filtered.length) {
            filtered.forEach(s => {
                const selected = (s.SubtypeID == selectedSubtypeId) ? 'selected' : '';
                subtypeSelect.append(`<option value="${s.SubtypeID}" ${selected}>${s.ServiceSubType}</option>`);
            });
        } else {
            subtypeSelect.append('<option>No subtypes available</option>');
        }

        subtypeSelect.val(selectedSubtypeId || null).trigger('change');
    }

    categorySelect.change(function () {
        populateSubtypes($(this).val(), null);
    });

    if (modelCategory) populateSubtypes(modelCategory, modelSubtype);

            function loadTimeSlots() {
            const date = $('input[name="AppointmentDate"]').val();
            const select = $('#timeSlots');
            if (!date) return;

            $.get('@Url.Action("GetAvailableTimeSlots", "Admin")', { date, excludeId: '@Model.AppointmentID' }, function (slots) {
                select.empty();
                if (!slots || !slots.length) {
                    select.append('<option value="">No slots available</option>');
                    return;
                }

                if (modelTime && !slots.includes(modelTime)) {
                    slots.push(modelTime);
                    slots.sort(); 
                }

                slots.forEach(slot => {
                    const display = new Date(`1970-01-01T${slot}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const selected = (slot === modelTime) ? 'selected' : '';
                    select.append(`<option value="${slot}" ${selected}>${display}</option>`);
                });

                select.trigger('change');
            });
        }


    $('input[name="AppointmentDate"]').change(loadTimeSlots);
    loadTimeSlots();

    $('#editAppointmentForm').on('submit', function (e) {
        e.preventDefault();
        const modal = new bootstrap.Modal('#confirmSaveModal');
        modal.show();

        $('#confirmSaveBtn').off('click').on('click', function () {
            modal.hide();
            $.post('@Url.Action("EditAppointment", "Admin")', $('#editAppointmentForm').serialize())
                .done(res => {
                    const toastEl = $('#messageToast');
                    const toastBody = toastEl.find('.toast-body');
                    toastBody.text(res.message);
                    toastEl.removeClass('bg-success bg-danger').addClass(res.success ? 'bg-success' : 'bg-danger');
                    new bootstrap.Toast(toastEl[0]).show();

                    if (res.success) setTimeout(() => window.location.href = '@Url.Action("Appointments", "Admin")', 1200);
                });
        });
    });
});
</script>
}
