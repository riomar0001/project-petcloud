@model PurrVet.Models.AppointmentDraftGroupVM
@using System.Text.Json
@{
    Layout = "~/Views/Shared/_DashboardLayoutModern.cshtml";
    ViewBag.Title = "Edit Draft Group";

    var simpleSubtypes = JsonSerializer.Serialize(Model.Subtypes.Select(s => new { s.SubtypeID, s.ServiceSubType, s.CategoryID }).ToList());
}

<div class="p-4">
    <h5 class="fw-bold mb-4">Drafts / Edit Group (@Model.GroupDraftId)</h5>

    <div class="card shadow-sm p-4">

        <!-- Toast -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
            <div id="messageToast" class="toast align-items-center text-white border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <form id="draftGroupForm" method="post" action="@Url.Action("SaveDraftGroup", "Staff")">
            @Html.AntiForgeryToken()
            <input type="hidden" name="GroupDraftId" value="@Model.GroupDraftId" />
            <input type="hidden" id="GroupDateHidden" name="GroupDate" />
            <input type="hidden" id="GroupTimeHidden" name="GroupTime" />
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Owner</label>
                    <select id="ownerSelect" name="OwnerID" class="form-select select2">
                        <option value="">Select Owner</option>
                        @foreach (var owner in Model.Owners)
                        {
                            <option value="@owner.OwnerID" selected="@(Model.Drafts.FirstOrDefault()?.OwnerID == owner.OwnerID ? "selected" : null)">@owner.Name</option>
                        }
                    </select>
                </div>
            </div>
            <div id="draftsContainer">
                @for (int i = 0; i < Model.Drafts.Count; i++)
                {
                    var d = Model.Drafts[i];
                    <div class="draft-block border rounded p-3 mb-3 position-relative bg-light">
                        <h6 class="fw-bold mb-3">Service #@(i + 1)</h6>
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 mt-2 me-2 remove-draft">×</button>

                        <input type="hidden" name="Drafts[@i].DraftID" value="@d.DraftID" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Pet</label>
                                <select name="Drafts[@i].PetID" class="form-select pet-select select2">
                                    @foreach (var pet in Model.OwnerPets)
                                    {
                                        <option value="@pet.PetID" selected="@(d.PetID == pet.PetID ? "selected" : null)">
                                            @pet.Name (@pet.Type)
                                        </option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Category</label>
                                <select name="Drafts[@i].CategoryID" class="form-select category-select select2">
                                    @foreach (var cat in Model.Categories)
                                    {
                                        <option value="@cat.CategoryID" selected="@(d.CategoryID == cat.CategoryID ? "selected" : null)">
                                            @cat.ServiceType
                                        </option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Subtype</label>
                                <select name="Drafts[@i].SubtypeID" class="form-select subtype-select select2">
                                    @foreach (var st in Model.Subtypes)
                                    {
                                        <option value="@st.SubtypeID" selected="@(d.SubtypeID == st.SubtypeID ? "selected" : null)">
                                            @st.ServiceSubType
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Date</label>
                                <input type="date" name="Drafts[@i].AppointmentDate" class="form-control appointment-date" value="@d.AppointmentDate.ToString("yyyy-MM-dd")" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Time</label>
                                <select name="Drafts[@i].AppointmentTime" class="form-select time-select" data-selected="@d.AppointmentTime"></select>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Notes</label>
                                <textarea name="Drafts[@i].Notes" class="form-control">@d.Notes</textarea>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="mt-3 text-end">
                <button type="button" id="addDraftBtn" class="btn btn-outline-primary">+ Add Service</button>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="button" id="saveDraftsBtn" class="btn btn-primary px-4">Save Drafts</button>
                <a href="@Url.Action("Appointments", "Staff")" class="btn btn-secondary px-4">Cancel</a>
            </div>

        </form>
    </div>
</div>

<!-- REMOVE CONFIRMATION -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title">Remove Service</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">Remove this service?</div>
            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmRemoveBtn" class="btn btn-danger px-4">Remove</button>
            </div>
        </div>
    </div>
</div>

<!-- SAVE CONFIRMATION -->
<div class="modal fade" id="confirmSaveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h6 class="modal-title">Confirm Save</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">Save drafts?</div>
            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmSaveBtn" class="btn btn-success px-4">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- ADD SERVICE CONFIRMATION -->
<div class="modal fade" id="confirmAddModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h6 class="modal-title">Add Service</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                Add a new service to this draft group?
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmAddBtn" class="btn btn-success px-4">Add</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        function removeLocalStorageDraft(groupId) {
            let cart = JSON.parse(localStorage.getItem("appointmentCart") || "[]");
            cart = cart.filter(item => item.GroupDraftId !== groupId);
            localStorage.setItem("appointmentCart", JSON.stringify(cart));
        }
        $(function () {
            // --- Data from server
            const allSubtypes = @Html.Raw(simpleSubtypes);

            // --- Cached DOM / state
            const container = $("#draftsContainer");
            let cachedPets = [];
            let pendingRemove = null;

            // toast helper
            function showToast(msg, ok = false) {
                const t = $("#messageToast");
                t.removeClass("bg-success bg-danger").addClass(ok ? "bg-success" : "bg-danger");
                t.find(".toast-body").text(msg);
                new bootstrap.Toast(t[0]).show();
            }

            // select2 initializer (safely destroys previous instances)
            function initSelect2(scope) {
                const $scope = scope ? $(scope) : $(document);
                $scope.find(".select2").each(function () {
                    try { $(this).select2('destroy'); } catch (e) { /* ignore */ }
                    $(this).select2({
                        width: "100%",
                        allowClear: true,
                        dropdownParent: $(this).closest('.modal').length ? $(this).closest('.modal') : $(document.body)
                    });
                });
            }

            // load pets for owner (populates pet-selects in the specified scope or whole document)
            function loadPets(ownerId, scope) {
                if (!ownerId) {
                    cachedPets = [];
                    $(scope || document).find(".pet-select").each(function () {
                        const $p = $(this);
                        $p.empty().append();
                        initSelect2($p.parent());
                    });
                    return;
                }

                $.get('@Url.Action("GetPetsByOwner", "Staff")', { ownerId })
                    .done(pets => {
                        cachedPets = pets || [];
                        $(scope || document).find(".pet-select").each(function () {
                            const $p = $(this);
                            const currentVal = $p.val();
                            $p.empty().append('<option value=""></option>');
                            cachedPets.forEach(pet => {
                                $p.append(`<option value="${pet.petID}">${pet.name} (${pet.type})</option>`);
                            });
                            // preserve existing value if possible
                            if (currentVal && $p.find(`option[value="${currentVal}"]`).length) {
                                $p.val(currentVal);
                            } else {
                                const firstOpt = $p.find('option[value!=""]:first').val();
                                if (firstOpt) $p.val(firstOpt);
                            }
                        });
                        initSelect2(scope);
                    })
                    .fail(() => showToast('Failed to load pets'));
            }

            // Populate subtypes for a category select element
                    function populateSubtypes(categorySelect, subtypeSelect, currentVal) {
            const catId = $(categorySelect).val();
            const $s = $(subtypeSelect);
            const previousVal = currentVal || $s.val(); 
            $s.empty();

            const filtered = allSubtypes.filter(x => String(x.CategoryID) === String(catId));
            filtered.forEach(x => $s.append(`<option value="${x.SubtypeID}">${x.ServiceSubType}</option>`));

            if (previousVal && $s.find(`option[value="${previousVal}"]`).length) {
                $s.val(previousVal);
            } else if (filtered.length > 0) {
                $s.val(filtered[0].SubtypeID);
            } else {
                $s.val("");
            }

            initSelect2($s.parent());
        }


            function applyDateTimeVisibility() {
                container.find('.draft-block').each(function (i) {
                    $(this).find('.appointment-date, .time-select').closest('.col-md-6').toggle(i === 0);
                });
            }

            // Sync master date/time to all other blocks
            function syncAllDatesTimes() {
                const masterDate = $('.draft-block:first .appointment-date').val();
                const masterTime = $('.draft-block:first .time-select').val();
                container.find('.draft-block').each(function (i) {
                    if (i === 0) return;
                    $(this).find('.appointment-date').val(masterDate);
                    $(this).find('.time-select').val(masterTime);
                    $(this).find('.time-select').trigger('change');
                });
            }

                    function fixIndexes() {
            container.find('.draft-block').each(function (i) {

                $(this).find('input[name], select[name], textarea[name]').each(function () {
                    let name = $(this).attr('name');

                    if (name.startsWith("Drafts[")) {
                        name = name.replace(/Drafts\[\d+\]/, `Drafts[${i}]`);
                        $(this).attr('name', name);
                    }
                });

                $(this).find('h6').text(`Service #${i + 1}`);
            });
        }

            function readDraftCart() {
                try {
                    return JSON.parse(localStorage.getItem("appointmentCart") || "[]");
                } catch (e) {
                    return [];
                }
            }
            function writeDraftCart(arr) {
                try {
                    localStorage.setItem("appointmentCart", JSON.stringify(arr));
                } catch (e) {
                    console.error("Failed writing draft cart to localStorage", e);
                }
            }
                   function populateTimeOptions() {
            const cartItems = readDraftCart(); // localStorage

            const master = container.find('.draft-block:first');
            const date = master.find('.appointment-date').val();
            const assignedTime = master.find('.time-select').data('selected'); 
            const $timeSelect = master.find('.time-select');

            $timeSelect.find('option').each(function () {
                if (!$(this).data('base-text')) $(this).data('base-text', $(this).text());
            });

            const bookedTimes = cartItems
                .filter(i => i.date && i.time)
                .map(d => `${d.date}-${d.time}`);

            $timeSelect.find('option').each(function () {
                const val = $(this).val();
                const baseText = $(this).data('base-text') || $(this).text();
                const key = `${date}-${val}`;

                if (!date || !val) {
                    $(this).prop('disabled', false).text(baseText);
                    return;
                }

                if (val === assignedTime) {
                    $(this).prop('disabled', false).text(`${baseText} (Current)`);
                } else if (bookedTimes.includes(key)) {
                    $(this).prop('disabled', true).text(`${baseText} (Added to List)`);
                } else {
                    $(this).prop('disabled', false).text(baseText);
                }
            });
        }

            function initTimeOptionsBaseText() {
                container.find('.time-select').each(function () {
                    $(this).find('option').each(function () {
                        if (!$(this).data('base-text')) $(this).data('base-text', $(this).text());
                    });
                });
            }

            function updateGroupHiddenFields() {
                const d = $('.draft-block:first .appointment-date').val() || "";
                const t = $('.draft-block:first .time-select').val() || "";
                if ($("#GroupDateHidden").length === 0) {
                    $("#draftGroupForm").append(`<input type="hidden" id="GroupDateHidden" name="GroupDate" />`);
                }
                if ($("#GroupTimeHidden").length === 0) {
                    $("#draftGroupForm").append(`<input type="hidden" id="GroupTimeHidden" name="GroupTime" />`);
                }
                $("#GroupDateHidden").val(d);
                $("#GroupTimeHidden").val(t);
            }

                    async function loadAvailableTimeSlotsForBlock(block) {
            const dateInput = block.find(".appointment-date");
            const timeSelect = block.find(".time-select");
            const selectedDate = dateInput.val();
            if (!selectedDate) return;

            try {
                const res = await fetch(`/Staff/GetAvailableTimeSlots?date=${selectedDate}`);
                if (!res.ok) {
                    console.error("Error fetching time slots");
                    return;
                }

                const slots = await res.json();

                const previous = timeSelect.val();
                const original = timeSelect.data("selected");

                timeSelect.empty();

                if (!slots || !slots.length) {
                    timeSelect.append(`<option value="">No available time slots</option>`);
                    return;
                }

                slots.forEach(t => {
                    timeSelect.append(`<option value="${t}">${t}</option>`);
                });

                timeSelect.find("option").each(function () {
                    if (!$(this).data("base-text")) {
                        $(this).data("base-text", $(this).text());
                    }
                });

                if (previous && timeSelect.find(`option[value="${previous}"]`).length) {
                    timeSelect.val(previous);
                } else if (original && timeSelect.find(`option[value="${original}"]`).length) {
                    timeSelect.val(original);
                }

            } catch (err) {
                console.error("Timeslot error:", err);
            }
        }

            $(document).on('click', '.remove-draft', function () {
                if (container.find('.draft-block').length <= 1) return showToast("Must keep at least 1 service.");
                pendingRemove = $(this).closest('.draft-block');
                new bootstrap.Modal('#confirmRemoveModal').show();
            });

            $('#confirmRemoveBtn').on('click', function () {
                if (pendingRemove) {
                    pendingRemove.remove();
                    pendingRemove = null;
                    fixIndexes();
                    applyDateTimeVisibility();
                    syncAllDatesTimes();
                    populateTimeOptions();
                    showToast("Service removed.", true);
                }
                bootstrap.Modal.getInstance(document.getElementById('confirmRemoveModal')).hide();
            });

            $('#addDraftBtn').off('click').on('click', function () {
                if (container.find('.draft-block').length >= 3) return showToast("Maximum 3 services per draft group.");
                if (!cachedPets.length) return showToast("Select an owner first.");

                const modal = new bootstrap.Modal('#confirmAddModal');
                modal.show();

                $('#confirmAddBtn').off('click').on('click', function () {
                    modal.hide();

                    const first = container.find('.draft-block:first');
                    const idx = container.find('.draft-block').length;

                    const block = $(`
                        <div class="draft-block border rounded p-3 mb-3 position-relative bg-light">
                            <h6 class="fw-bold mb-3">Service #${idx + 1}</h6>
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 mt-2 me-2 remove-draft">×</button>
                            <input type="hidden" name="Drafts[${idx}].DraftID" value="0" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Pet</label>
                                    <select name="Drafts[${idx}].PetID" class="form-select pet-select select2"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Category</label>
                                    <select name="Drafts[${idx}].CategoryID" class="form-select category-select select2">
                                        ${first.find('.category-select').html()}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Subtype</label>
                                    <select name="Drafts[${idx}].SubtypeID" class="form-select subtype-select select2"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Date</label>
                                    <input type="date" name="Drafts[${idx}].AppointmentDate" class="form-control appointment-date" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Time</label>
                                    <select name="Drafts[${idx}].AppointmentTime" class="form-select time-select select2"></select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Notes</label>
                                    <textarea name="Drafts[${idx}].Notes" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    `);

                    const $pet = block.find('.pet-select');
                    $pet.append('<option value=""></option>');
                    cachedPets.forEach(p => {
                        $pet.append(`<option value="${p.petID}">${p.name} (${p.type})</option>`);
                    });
                    if (cachedPets.length) $pet.val(cachedPets[0].petID);
                    const $cat = block.find('.category-select');
                    const $sub = block.find('.subtype-select');
                    populateSubtypes($cat, $sub, null);
                    const masterDate = first.find('.appointment-date').val();
                    const masterTime = first.find('.time-select').val();
                    block.find('.appointment-date').val(masterDate);
                    block.find('.time-select').data("selected", masterTime);
                    container.append(block);
                    initSelect2(block);


                    loadAvailableTimeSlotsForBlock(block).then(() => {
                       if (masterTime) {
                        block.find('.time-select').val(masterTime).trigger('change');
                    }
                        applyDateTimeVisibility();
                        syncAllDatesTimes();
                    });
                });
            });

            $(document).on('change', '.draft-block:first .appointment-date', function () {
                syncAllDatesTimes();
                const master = $('.draft-block:first');
                loadAvailableTimeSlotsForBlock(master).then(() => {
                    populateTimeOptions();
                    updateGroupHiddenFields();
                });
            });

            $(document).on('change', '.draft-block:first .time-select', function () {
                syncAllDatesTimes();
                updateGroupHiddenFields();
            });

            $(document).on('change', '.appointment-date', function () {
                const block = $(this).closest('.draft-block');
                loadAvailableTimeSlotsForBlock(block).then(() => {
                    populateTimeOptions();
                });
            });

            $(document).on('change', '.category-select', function () {
                const $cat = $(this);
                const $block = $cat.closest('.draft-block');
                const $sub = $block.find('.subtype-select');
                populateSubtypes($cat, $sub, null);
            });

            initSelect2();
            initTimeOptionsBaseText();
            loadPets($('#ownerSelect').val());
            $('#ownerSelect').on('change', function () { loadPets($(this).val()); });


            container.find('.draft-block').each(function () {
                const b = $(this);
                populateSubtypes(b.find('.category-select'), b.find('.subtype-select'), b.find('.subtype-select').data('subtype') || b.find('.subtype-select').attr('data-subtype'));

                const selectedOwner = $('#ownerSelect').val();
                if (selectedOwner) loadPets(selectedOwner, b);
                const tSel = b.find('.time-select');
                const ds = tSel.attr('data-selected');
                if (ds) tSel.data('selected', ds);
                loadAvailableTimeSlotsForBlock(b);
            });

            setTimeout(() => {
                applyDateTimeVisibility();
                syncAllDatesTimes();
                populateTimeOptions();
                updateGroupHiddenFields();
            }, 200);

            function ensureGroupDraftId(form) {
                const hidden = form.find('[name="GroupDraftId"]');
                let gid = hidden.val();
                if (!gid) {
                    gid = 'Draft-' + Date.now() + '-' + Math.floor(Math.random() * 99999);
                    if (hidden.length) hidden.val(gid);
                    else form.append(`<input type="hidden" name="GroupDraftId" value="${gid}" />`);
                }
                return gid;
            }

            $('#saveDraftsBtn').on('click', function () { new bootstrap.Modal('#confirmSaveModal').show(); });

            $('#confirmSaveBtn').off('click').on('click', function () {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmSaveModal'));
            modal.hide();
            fixIndexes();
            // push select2 values to selects
            $('.select2').each(function () { const $el = $(this); const v = $el.val(); $el.val(v).trigger('change'); });

            syncAllDatesTimes();
            updateGroupHiddenFields();
            populateTimeOptions();

            const masterDate = $('.draft-block:first .appointment-date').val();
            const masterTime = $('.draft-block:first .time-select').val();
            const drafts = [];
            const blocks = container.find('.draft-block');

            for (let i = 0; i < blocks.length; i++) {
                const block = $(blocks[i]);
                drafts.push({
                    ownerID: $("#ownerSelect").val(),
                    petID: block.find(".pet-select").val(),
                    petName: block.find(".pet-select option:selected").text(),
                    categoryID: block.find(".category-select").val(),
                    categoryName: block.find(".category-select option:selected").text(),
                    subtypeID: block.find(".subtype-select").val(),
                    subtypeName: block.find(".subtype-select option:selected").text(),
                    appointmentDate: block.find(".appointment-date").val(),
                    appointmentTime: block.find(".time-select").val(),
                    notes: block.find("textarea[name$='Notes']").val() || "No notes.",
                    groupDraftId: ensureGroupDraftId($('#draftGroupForm'))
                });
            }

            drafts.forEach((d, i) => {
                d.date = d.appointmentDate;
                d.time = (i === 0) ? d.appointmentTime : null; 
            });

            removeLocalStorageDraft(drafts[0]?.groupDraftId);

            let cart = readDraftCart();
            const groupId = drafts[0].groupDraftId;
            cart = cart.filter(c => (c.groupDraftId || "") !== groupId);
            cart.push(...drafts);
            writeDraftCart(cart);


            $('#confirmSaveBtn').prop('disabled', true).text('Saving...');
            $.ajax({
                url: $('#draftGroupForm').attr('action'),
                method: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    ownerID: $("#ownerSelect").val(),
                    groupDraftId: drafts[0].groupDraftId,
                    drafts: drafts
                }),
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                success: function (res) {
                    $('#confirmSaveBtn').prop('disabled', false).text('Save');
                    if (!res || res.success === undefined) return showToast("Unexpected response");

                    showToast(res.message, res.success);
                    if (res.success) {
                        setTimeout(() => window.location.href = '@Url.Action("Appointments", "Staff")', 700);
                    }
                },
                error: function (xhr) {
                    $('#confirmSaveBtn').prop('disabled', false).text('Save');
                    showToast(xhr.responseJSON?.message || "Failed to save");
                }
            });
        });
                $("#draftGroupForm").on("submit", function (e) {
            e.preventDefault();

            const form = $(this);

            $.ajax({
                url: form.attr("action"),
                type: "POST",
                data: form.serialize(),
                success: function (res) {
                    if (res.success) {
                        const updatedGroup = {
                            groupDraftId: res.groupDraftId,
                            GroupDate: res.groupDate,
                            GroupTime: res.groupTime,
                            OwnerID: $("#ownerSelect").val()
                        };

                        saveGroupToCart(updatedGroup);

                        showToast("Draft group saved!", true);
                    } else {
                        showToast("Save failed.");
                    }
                },
                error: function () {
                    showToast("Error saving group.");
                }
            });
        });

          
            function syncDraftHiddenFields() {
                const masterDate = $('.draft-block:first .appointment-date').val() || "";
                const masterTime = $('.draft-block:first .time-select').val() || "";

                container.find('.draft-block').each(function () {
                    $(this).find('.appointment-date').val(masterDate);
                    $(this).find('.time-select').val(masterTime);
                });

                updateGroupHiddenFields();
            }

        }); 
        function saveGroupToCart(updated) {
            let cart = JSON.parse(localStorage.getItem("appointmentCart") || "[]");

            const index = cart.findIndex(x => x.groupDraftId === updated.groupDraftId);

            if (index !== -1) {
                cart[index] = updated; 
            } else {
                cart.push(updated); 
            }

            localStorage.setItem("appointmentCart", JSON.stringify(cart));
        }

    </script>
}
