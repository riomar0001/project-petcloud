@{
    Layout = "~/Views/Shared/_DashboardLayoutModern.cshtml";
    ViewBag.Title = "Reports";
}

<!-- Dashboard Header -->
<div class="dashboard-header">
    <h2>Reports</h2>
    <p>Generate and export system reports</p>
</div>

<div class="page-card-modern">
    <div class="card-header-modern">
        <h6>GENERATE REPORTS</h6>
    </div>

    <div class="card-body p-4">
        <!-- Toast -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
            <div id="messageToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <form id="reportForm" class="row g-3">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Report Type</label>
                <select id="reportType" class="form-select">
                    <option value="">-- Select Report Type --</option>
                    <option value="appointments">Appointments</option>
                    <option value="notifications">Notifications</option>
                    <option value="logs">System Logs</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-semibold">From</label>
                <input type="date" id="dateFrom" class="form-control" />
            </div>

            <div class="col-md-2">
                <label class="form-label fw-semibold">To</label>
                <input type="date" id="dateTo" class="form-control" />
            </div>

            <div class="col-md-3" id="categoryContainer" style="display:none;">
                <label class="form-label fw-semibold">Category</label>
                <select id="categoryFilter" class="form-select dropdown">
                    <option value="0">All</option>
                </select>
            </div>

            <div class="col-md-3" id="typeContainer" style="display:none;">
                <label class="form-label fw-semibold">Type</label>
                <select id="typeFilter" class="form-select">
                    <option value="0">All</option>
                </select>
            </div>

            <div class="col-md-2" id="statusContainer" style="display:none;">
                <label class="form-label fw-semibold">Status</label>
                <select id="statusFilter" class="form-select">
                    <option value="All">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>

            <div class="col-md-2" id="notifTypeContainer" style="display:none;">
                <label class="form-label fw-semibold">Notification Type</label>
                <select id="notifTypeFilter" class="form-select">
                    <option value="All">All</option>
                </select>
            </div>

            <div class="col-md-2" id="isReadContainer" style="display:none;">
                <label class="form-label fw-semibold">Read</label>
                <select id="readFilter" class="form-select">
                    <option value="All">All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="col-md-2" id="actionTypeContainer" style="display:none;">
                <label class="form-label fw-semibold">Action Type</label>
                <select id="logActionTypeFilter" class="form-select">
                    <option value="All">All</option>
                </select>
            </div>

            <div class="col-md-2" id="moduleContainer" style="display:none;">
                <label class="form-label fw-semibold">Module</label>
                <select id="logModuleFilter" class="form-select">
                    <option value="All">All</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-semibold">Sort Date</label>
                <select id="dateSort" class="form-select">
                    <option value="desc">Newest First</option>
                    <option value="asc">Oldest First</option>
                </select>
            </div>

            <div class="col-12 mt-3 d-flex justify-content-end gap-2">
                <button type="button" id="generateReport" class="btn-add-modern">Generate</button>
                <button type="button" id="downloadPdf" class="btn btn-secondary fw-semibold" style="border-radius: 8px;">
                    <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                </button>
                <button type="button" id="downloadCsv" class="btn btn-secondary fw-semibold" style="border-radius: 8px;">
                    <i class="bi bi-filetype-csv me-1"></i> CSV
                </button>
            </div>
        </form>

        <div id="reportResult" class="mt-4" style="display:none;">
            <h6 class="fw-bold mb-3">Report Results</h6>
            <div class="table-responsive" style="max-height:400px; overflow-y:auto;">
                <table id="reportTable" class="table-modern-list">
                    <thead id="reportHeaders"></thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            const serviceCategories = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ServiceCategories));
            const serviceSubtypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ServiceSubtypes));
            const notifActionTypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.NotificationActionTypes ?? new List<string>()));
            const logActionTypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.LogActionTypes ?? new List<string>()));
            const logModules = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.LogModules ?? new List<string>()));

            const $categoryFilter = $('#categoryFilter');
            const $typeFilter = $('#typeFilter');
            const $actionTypeFilter = $('#logActionTypeFilter');
            const $moduleFilter = $('#logModuleFilter');

            $categoryFilter.empty().append('<option value="0">All</option>');
            serviceCategories.forEach(c => {
                const id = c.CategoryID ?? c.categoryID ?? c.categoryId;
                const name = c.ServiceType ?? c.serviceType ?? c.service;
                $categoryFilter.append(`<option value="${id}">${name ?? ''}</option>`);
            });

            $typeFilter.empty().append('<option value="0">All</option>');
            $categoryFilter.on('change', function () {
                const catId = parseInt($(this).val() || '0', 10);
                $typeFilter.empty().append('<option value="0">All</option>');
                if (catId > 0) {
                    serviceSubtypes
                        .filter(s => {
                            const sid = s.CategoryID ?? s.categoryID ?? s.categoryId;
                            return parseInt(sid, 10) === catId;
                        })
                        .forEach(t => {
                            const tid = t.SubtypeID ?? t.subtypeID ?? t.subtypeId;
                            const tname = t.ServiceSubType ?? t.serviceSubType ?? t.serviceSubTypeName;
                            $typeFilter.append(`<option value="${tid}">${tname ?? ''}</option>`);
                        });
                }
            });

                    $('#reportType').on('change', function () {
            const type = $(this).val();
            $('#categoryContainer, #typeContainer, #statusContainer, #notifTypeContainer, #isReadContainer, #actionTypeContainer, #moduleContainer').hide();

            if (type === 'appointments') {
                $('#categoryContainer, #typeContainer, #statusContainer').fadeIn();
            }

                  if (type === 'notifications') {
            $('#notifTypeContainer, #isReadContainer').fadeIn();

            const $notifTypeFilter = $('#notifTypeFilter');
            const notifTypes = ['Appointment', 'User', 'Owner', 'Pet'];
            $notifTypeFilter.empty().append('<option value="All">All</option>');
            notifTypes.forEach(a => $notifTypeFilter.append(`<option value="${a}">${a}</option>`));

            $actionTypeFilter.empty().append('<option value="All">All</option>');
        }


            if (type === 'logs') {
                $('#actionTypeContainer, #moduleContainer').fadeIn();

                $actionTypeFilter.empty().append('<option value="All">All</option>');
                logActionTypes.forEach(a => $actionTypeFilter.append(`<option value="${a}">${a}</option>`));

                $moduleFilter.empty().append('<option value="All">All</option>');
                logModules.forEach(m => $moduleFilter.append(`<option value="${m}">${m}</option>`));
            }
        });


            const getFormData = () => ({
                type: $('#reportType').val(),
                from: $('#dateFrom').val(),
                to: $('#dateTo').val(),
                categoryFilter: $('#categoryFilter').val() || "0",
                typeFilter: $('#typeFilter').val() || "0",
                statusFilter: $('#statusFilter').val() || "All",
                dateSort: $('#dateSort').val() || "desc",
                readFilter: $('#readFilter').val() || "All",
                notifTypeFilter: $('#notifTypeFilter').val() || "All",
                logActionTypeFilter: $('#logActionTypeFilter').val() || "All",
                logModuleFilter: $('#logModuleFilter').val() || "All"
            });

            const showToast = (msg, cls = 'bg-success') => {
                $('#messageToast .toast-body').text(msg);
                $('#messageToast').removeClass('bg-success bg-danger bg-warning').addClass(cls);
                new bootstrap.Toast(document.getElementById('messageToast')).show();
            };

            $('#generateReport').click(function () {
                const data = getFormData();
                if (!data.type) { showToast('Please select report type', 'bg-danger'); return; }

                $.getJSON('@Url.Action("GenerateReport", "Staff")', data, function (res) {
                    $('#reportHeaders, #reportBody').empty();
                    $('#reportResult').fadeIn();

                    if (!res || !res.length) {
                        $('#reportBody').append('<tr><td colspan="10">No records found</td></tr>');
                        showToast('No records found', 'bg-warning');
                        return;
                    }

                    const headers = Object.keys(res[0]);
                    headers.forEach(h => $('#reportHeaders').append('<th>' + h + '</th>'));
                    res.forEach(row => {
                        const cells = headers.map(h => `<td>${row[h] ?? ''}</td>`).join('');
                        $('#reportBody').append('<tr>' + cells + '</tr>');
                    });
                    showToast('Report loaded successfully!');
                });
            });

            $('#downloadPdf').click(() => window.open('@Url.Action("DownloadReportPdf", "Staff")?' + $.param(getFormData())));
            $('#downloadCsv').click(() => window.open('@Url.Action("DownloadReportCsv", "Staff")?' + $.param(getFormData())));
        });
    </script>
}
